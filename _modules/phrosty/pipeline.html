<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>phrosty.pipeline &#8212; phrosty 0.1.dev1+g3fbaab0a0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=5a6b8c39" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=f3bc516d" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <script src="../../_static/documentation_options.js?v=78713410"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo_black_filled.png" alt="Logo" />
    
  </a>
</p>



<p class="blurb">Software developed by the Roman SNPIT</p>






<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">phrosty API</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <h1>Source code for phrosty.pipeline</h1><div class="highlight"><pre>
<span></span><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;PipelineImage&#39;</span><span class="p">,</span> <span class="s1">&#39;Pipeline&#39;</span> <span class="p">]</span>

<span class="c1"># Imports STANDARD</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cupy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nvtx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tracemalloc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="c1"># Imports ASTRO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.wcs.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">skycoord_to_pixel</span>

<span class="c1"># Imports INTERNAL</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">phrosty.imagesubtraction</span><span class="w"> </span><span class="kn">import</span> <span class="n">sky_subtract</span><span class="p">,</span> <span class="n">stampmaker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sfft.SpaceSFFTCupyFlow</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpaceSFFT_CupyFlow</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.diaobject</span><span class="w"> </span><span class="kn">import</span> <span class="n">DiaObject</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.imagecollection</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImageCollection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.image</span><span class="w"> </span><span class="kn">import</span> <span class="n">FITSImageOnDisk</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">PSF</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snpit_utils.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snpit_utils.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">SNLogger</span>


<div class="viewcode-block" id="PipelineImage">
<a class="viewcode-back" href="../../api/phrosty.pipeline.PipelineImage.html#phrosty.pipeline.PipelineImage">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PipelineImage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Holds a snappl.image.Image, with some other stuff the pipeline needs.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">pipeline</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a PipelineImage</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">           image : snappl.image.Image</span>
<span class="sd">              The image we&#39;re encapsulating.  Pass either this or imagepath.</span>

<span class="sd">           pipeline : phrosty.pipeline.Pipeline</span>
<span class="sd">              The pipeline that owns this image.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">temp_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.keep_intermediate&#39;</span> <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.paths.scratch_dir&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">image</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">band</span> <span class="o">!=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">band</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Image </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has a band </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s2">, &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;which is different from the pipeline band </span><span class="si">{</span><span class="n">pipeline</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

        <span class="c1"># Intermediate files</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span><span class="p">:</span>
            <span class="c1"># Set to None. The path gets defined later on.</span>
            <span class="c1"># They have to be defined here in __init__ so that they exist</span>
            <span class="c1"># and are accessible in later functions.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skysub_img</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detmask_img</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_sci_psf_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_templ_psf_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_templ_img_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_templ_var_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_templ_psf_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crossconv_sci_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crossconv_templ_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diff_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decorr_kernel_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Always save and output these</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorr_psf_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorr_zptimg_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorr_diff_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zpt_stamp_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_var_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_var_stamp_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_stamp_path</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Held in memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyrms</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psfobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_data</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="PipelineImage.run_sky_subtract">
<a class="viewcode-back" href="../../api/phrosty.pipeline.PipelineImage.html#phrosty.pipeline.PipelineImage.run_sky_subtract">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_sky_subtract</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">mp</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sky_subtract</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span> <span class="n">ex</span> <span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="PipelineImage.save_sky_subtract_info">
<a class="viewcode-back" href="../../api/phrosty.pipeline.PipelineImage.html#phrosty.pipeline.PipelineImage.save_sky_subtract_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_sky_subtract_info</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">info</span> <span class="p">):</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Saving sky_subtract info for path </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skysub_img</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detmask_img</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyrms</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></div>


<div class="viewcode-block" id="PipelineImage.get_psf">
<a class="viewcode-back" href="../../api/phrosty.pipeline.PipelineImage.html#phrosty.pipeline.PipelineImage.get_psf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_psf</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the at the right spot on the image.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          ra, dec : float</span>
<span class="sd">             The coordinates in decimal degrees where we want the PSF.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: right now snappl.psf.PSF.get_psf_object just</span>
        <span class="c1">#   passes the keyword arguments on to whatever makes</span>
        <span class="c1">#   the psf... and it&#39;s different for each type of</span>
        <span class="c1">#   PSF.  We need to fix that... somehow....</span>

        <span class="n">wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">get_wcs</span><span class="p">()</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psfobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psftype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.psf.type&#39;</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psfobj</span> <span class="o">=</span> <span class="n">PSF</span><span class="o">.</span><span class="n">get_psf_object</span><span class="p">(</span> <span class="n">psftype</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span>
                                              <span class="n">band</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">band</span><span class="p">,</span>
                                              <span class="n">pointing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">pointing</span><span class="p">,</span>
                                              <span class="n">sca</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span> <span class="p">)</span>

        <span class="n">stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psfobj</span><span class="o">.</span><span class="n">get_stamp</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;psf_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.fits&quot;</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">stamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">stamp</span></div>


<div class="viewcode-block" id="PipelineImage.keep_psf_data">
<a class="viewcode-back" href="../../api/phrosty.pipeline.PipelineImage.html#phrosty.pipeline.PipelineImage.keep_psf_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">keep_psf_data</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">psf_data</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_data</span> <span class="o">=</span> <span class="n">psf_data</span></div>


<div class="viewcode-block" id="PipelineImage.free">
<a class="viewcode-back" href="../../api/phrosty.pipeline.PipelineImage.html#phrosty.pipeline.PipelineImage.free">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">free</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to free memory.  More might be done here.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skysub_img</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detmask_img</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_data</span> <span class="o">=</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="Pipeline">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Pipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Phrosty&#39;s top-level pipeline&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">diaobj</span><span class="p">,</span> <span class="n">imgcol</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
                  <span class="n">science_images</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">template_images</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">science_csv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">template_csv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">nprocs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nwrite</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the a pipeline object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">           diaobj : DiaObject</span>
<span class="sd">             The object we&#39;re building a lightcurve for</span>

<span class="sd">           band: str</span>
<span class="sd">             One of R062, Z087, Y106, J129, H158, F184, K213</span>

<span class="sd">           science_images: list of snappl.image.Image</span>
<span class="sd">             The science images.</span>

<span class="sd">           template_images: list of snappl.image.Image</span>
<span class="sd">             The template images.</span>

<span class="sd">           science_csv: Path or str</span>
<span class="sd">             CSV file with the science images.  The first line must be::</span>

<span class="sd">               path pointing sca mjd band</span>

<span class="sd">             subsequent lines must have that information for all the</span>
<span class="sd">             science images.  path must be relative to ou24.images in</span>
<span class="sd">             config.  Pipeline will extract the images from this file</span>
<span class="sd">             whose band matches the band of the pipeline (and ignore</span>
<span class="sd">             the rest)</span>

<span class="sd">           template_csv: Path or str</span>
<span class="sd">             CSV file with template images.  Same format as science_csv.</span>

<span class="sd">           nprocs: int, default 1</span>
<span class="sd">             Number of cpus for the CPU multiprocessing segments of the pipeline.</span>
<span class="sd">             (GPU segments will run a single process.)</span>

<span class="sd">           nwrite: int, default 5</span>
<span class="sd">             Number of asynchronous FITS writer processes.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">SNLogger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imgcol</span> <span class="o">=</span> <span class="n">imgcol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span> <span class="o">=</span> <span class="n">diaobj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">band</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.paths.dia_out_dir&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scratch_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.paths.scratch_dir&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir_parent</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.paths.temp_dir&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir_parent</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ltcv_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.paths.ltcv_dir&#39;</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">science_images</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span> <span class="n">science_csv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Pass exactly one of science_images or science_csv&quot;</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">science_csv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">science_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_csv</span><span class="p">(</span> <span class="n">science_csv</span> <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span> <span class="n">template_images</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">)</span> <span class="o">==</span> <span class="p">(</span> <span class="n">template_csv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="s2">&quot;Pass exactly one of template_images or template_csv&quot;</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">template_csv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">template_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_csv</span><span class="p">(</span> <span class="n">template_csv</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span> <span class="o">=</span> <span class="p">[</span> <span class="n">PipelineImage</span><span class="p">(</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">science_images</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span> <span class="o">=</span> <span class="p">[</span> <span class="n">PipelineImage</span><span class="p">(</span> <span class="n">i</span><span class="p">,</span> <span class="bp">self</span> <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">template_images</span> <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">=</span> <span class="n">nprocs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwrite</span> <span class="o">=</span> <span class="n">nwrite</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.keep_intermediate&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_temp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.remove_temp_dir&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.mem_trace&#39;</span> <span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_read_csv</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">csvfile</span> <span class="p">):</span>
        <span class="n">imlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">csvfile</span> <span class="p">)</span> <span class="k">as</span> <span class="n">ifp</span><span class="p">:</span>
            <span class="n">hdrline</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span> <span class="sa">r</span><span class="s2">&quot;^\s*path\s+pointing\s+sca\s+mjd\s+band\s*$&quot;</span><span class="p">,</span> <span class="n">hdrline</span> <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;First line of list file </span><span class="si">{</span><span class="n">csvfile</span><span class="si">}</span><span class="s2"> didn&#39;t match what was expected.&quot;</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ifp</span><span class="p">:</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">pointing</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">mjd</span><span class="p">,</span> <span class="n">band</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">band</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">:</span>
                    <span class="c1"># This should yell at us if the pointing or sca doesn&#39;t match what is read from the path</span>
                    <span class="n">imlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">imgcol</span><span class="o">.</span><span class="n">get_image</span><span class="p">(</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">pointing</span><span class="o">=</span><span class="n">pointing</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="n">sca</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">imlist</span>


<div class="viewcode-block" id="Pipeline.sky_sub_all_images">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline.sky_sub_all_images">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sky_sub_all_images</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="c1"># Currently, this writes out a bunch of FITS files.  Further refactoring needed</span>
        <span class="c1">#   to support more general image types.</span>
        <span class="n">all_imgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>     <span class="c1"># shallow copy</span>
        <span class="n">all_imgs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_omg</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">x</span> <span class="p">):</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Sky subtraction subprocess failure: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> for image </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_omg</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">all_imgs</span><span class="p">:</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span> <span class="n">img</span><span class="o">.</span><span class="n">run_sky_subtract</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{},</span>
                                      <span class="n">callback</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">save_sky_subtract_info</span><span class="p">,</span>
                                      <span class="n">error_callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">log_error</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">all_imgs</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">save_sky_subtract_info</span><span class="p">(</span> <span class="n">img</span><span class="o">.</span><span class="n">run_sky_subtract</span><span class="p">(</span> <span class="n">mp</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omg</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="s2">&quot;Sky subtraction errors.&quot;</span> <span class="p">)</span></div>



<div class="viewcode-block" id="Pipeline.get_psfs">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline.get_psfs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_psfs</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">all_imgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>     <span class="c1"># shallow copy</span>
        <span class="n">all_imgs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_omg</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span> <span class="n">x</span> <span class="p">):</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;get_psf subprocess failure: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_omg</span> <span class="o">=</span> <span class="kc">True</span>    <span class="c1"># noqa: F841</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">all_imgs</span><span class="p">:</span>
                    <span class="c1"># callback_partial = partial( img.save_psf_path, all_imgs )</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span> <span class="n">img</span><span class="o">.</span><span class="n">get_psf</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">dec</span><span class="p">),</span> <span class="p">{},</span>
                                      <span class="n">img</span><span class="o">.</span><span class="n">keep_psf_data</span><span class="p">,</span> <span class="n">log_error</span> <span class="p">)</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">all_imgs</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">keep_psf_data</span><span class="p">(</span> <span class="n">img</span><span class="o">.</span><span class="n">get_psf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omg</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="s2">&quot;get_psf errors.&quot;</span> <span class="p">)</span></div>



<div class="viewcode-block" id="Pipeline.align_and_pre_convolve">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline.align_and_pre_convolve">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">align_and_pre_convolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">,</span> <span class="n">sci_image</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Align and pre convolve a single template/science pair.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          sci_image: phrosty.PipelineImage</span>
<span class="sd">            The science (new) image.</span>

<span class="sd">          templ_image: phrosty.PipelineImage</span>
<span class="sd">            The template (ref) image that will be subtracted from sci_image.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          sfftifier: SpaceSFFT_CupyFlow</span>
<span class="sd">            Use this object for futher SFFT work.  Be sure to</span>
<span class="sd">            dereference it to free the prodigious amount of memory it</span>
<span class="sd">            allcoates.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># SFFT needs FITS headers with a WCS and with NAXIS[12]</span>
        <span class="n">hdr_sci</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">get_wcs</span><span class="p">()</span><span class="o">.</span><span class="n">get_astropy_wcs</span><span class="p">()</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span> <span class="n">relax</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="n">hdr_sci</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">hdr_sci</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="s1">&#39;NAXIS&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">,</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">),</span> <span class="n">after</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="n">hdr_sci</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="s1">&#39;NAXIS1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">,</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">),</span> <span class="n">after</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="n">data_sci</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span> <span class="p">)</span>
        <span class="n">noise_sci</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span> <span class="p">)</span>

        <span class="n">hdr_templ</span> <span class="o">=</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">get_wcs</span><span class="p">()</span><span class="o">.</span><span class="n">get_astropy_wcs</span><span class="p">()</span><span class="o">.</span><span class="n">to_header</span><span class="p">(</span> <span class="n">relax</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="n">hdr_templ</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;NAXIS&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">hdr_templ</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="s1">&#39;NAXIS&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;NAXIS1&#39;</span><span class="p">,</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">),</span> <span class="n">after</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="n">hdr_templ</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span> <span class="s1">&#39;NAXIS1&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;NAXIS2&#39;</span><span class="p">,</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">),</span> <span class="n">after</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="n">data_templ</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span> <span class="p">)</span>
        <span class="n">noise_templ</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">noise</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span> <span class="p">)</span>

        <span class="n">sci_psf</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">psf_data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">templ_psf</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">psf_data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span> <span class="p">)</span> <span class="p">)</span>

        <span class="n">sci_detmask</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">detmask_img</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">templ_detmask</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">detmask_img</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span> <span class="p">)</span> <span class="p">)</span>

        <span class="n">sfftifier</span> <span class="o">=</span> <span class="n">SpaceSFFT_CupyFlow</span><span class="p">(</span>
            <span class="n">hdr_sci</span><span class="p">,</span> <span class="n">hdr_templ</span><span class="p">,</span>
            <span class="n">sci_image</span><span class="o">.</span><span class="n">skyrms</span><span class="p">,</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">skyrms</span><span class="p">,</span>
            <span class="n">data_sci</span><span class="p">,</span> <span class="n">data_templ</span><span class="p">,</span>
            <span class="n">noise_sci</span><span class="p">,</span> <span class="n">noise_templ</span><span class="p">,</span>
            <span class="n">sci_detmask</span><span class="p">,</span> <span class="n">templ_detmask</span><span class="p">,</span>
            <span class="n">sci_psf</span><span class="p">,</span> <span class="n">templ_psf</span><span class="p">,</span>
            <span class="n">KerPolyOrder</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;photometry.phrosty.kerpolyorder&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">sfftifier</span><span class="o">.</span><span class="n">resampling_image_mask_psf</span><span class="p">()</span>
        <span class="n">sfftifier</span><span class="o">.</span><span class="n">cross_convolution</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">sfftifier</span></div>


<div class="viewcode-block" id="Pipeline.phot_at_coords">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline.phot_at_coords">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">phot_at_coords</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">pxcoords</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">ap_r</span><span class="o">=</span><span class="mi">4</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do photometry at forced set of pixel coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          img: snappl.image.Image</span>
<span class="sd">            The image on which to do the photometry</span>

<span class="sd">          psf: snappl.psf.PSF</span>
<span class="sd">            The PSF.</span>

<span class="sd">          pxcoords: tuple of (int, int)</span>
<span class="sd">            The position on the image to do the photometry</span>

<span class="sd">          ap_r: float</span>
<span class="sd">            Radius of aperture.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          results: dict</span>
<span class="sd">            Keys and values are:</span>
<span class="sd">            * &#39;aperture_sum&#39;: flux in aperture of radius ap_r</span>
<span class="sd">            * &#39;flux_fit&#39;: flux from PSF photometry</span>
<span class="sd">            * &#39;flux_fit_err&#39;: uncertainty on flux_fit</span>
<span class="sd">            * &#39;mag_fit&#39;: instrumental magnitude (i.e. no zeropoint) from flux_fit</span>
<span class="sd">            * &#39;mag_fit_err&#39;: uncertainty on mag_fit</span>

<span class="sd">            All values are floats.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">forcecoords</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">pxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">pxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
        <span class="n">init</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">ap_phot</span><span class="p">(</span> <span class="n">forcecoords</span><span class="p">,</span> <span class="n">ap_r</span><span class="o">=</span><span class="n">ap_r</span> <span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span> <span class="s1">&#39;aperture_sum&#39;</span><span class="p">,</span> <span class="s1">&#39;flux_init&#39;</span> <span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span> <span class="s1">&#39;xcenter&#39;</span><span class="p">,</span> <span class="s1">&#39;xcentroid&#39;</span> <span class="p">)</span>
        <span class="n">init</span><span class="o">.</span><span class="n">rename_column</span><span class="p">(</span> <span class="s1">&#39;ycenter&#39;</span><span class="p">,</span> <span class="s1">&#39;ycentroid&#39;</span> <span class="p">)</span>
        <span class="n">final</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">psf_phot</span><span class="p">(</span> <span class="n">init</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">forced_phot</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="n">flux</span> <span class="o">=</span> <span class="n">final</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">flux_err</span> <span class="o">=</span> <span class="n">final</span><span class="p">[</span><span class="s1">&#39;flux_err&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">final</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">mag_err</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">final</span><span class="p">[</span><span class="s2">&quot;flux_err&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">final</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;aperture_sum&#39;</span><span class="p">:</span> <span class="n">init</span><span class="p">[</span><span class="s1">&#39;flux_init&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;flux_fit&#39;</span><span class="p">:</span> <span class="n">flux</span><span class="p">,</span>
                        <span class="s1">&#39;flux_fit_err&#39;</span><span class="p">:</span> <span class="n">flux_err</span><span class="p">,</span>
                        <span class="s1">&#39;mag_fit&#39;</span><span class="p">:</span> <span class="n">mag</span><span class="p">,</span>
                        <span class="s1">&#39;mag_fit_err&#39;</span><span class="p">:</span> <span class="n">mag_err</span>
                        <span class="p">}</span>

        <span class="k">return</span> <span class="n">results_dict</span></div>


<div class="viewcode-block" id="Pipeline.make_phot_info_dict">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline.make_phot_info_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_phot_info_dict</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">,</span> <span class="n">ap_r</span><span class="o">=</span><span class="mi">4</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;&quot;Do things.</span>

<span class="sd">        Parmaeters</span>
<span class="sd">        ----------</span>
<span class="sd">          sci_image: PipelineImage</span>
<span class="sd">            science image wrapper</span>

<span class="sd">          temp_image: PipelineImage</span>
<span class="sd">            template image wrapper</span>

<span class="sd">          ap_r: float, default 4</span>
<span class="sd">             Radius of aperture to use in something</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          something: dict</span>
<span class="sd">            It has things in it</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Do photometry on stamp because it will read faster.</span>
        <span class="c1"># (We hope.  But CFS latency will kill you at 1 byte.)</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;...make_phot_info_dict reading stamp and psf&quot;</span> <span class="p">)</span>
        <span class="n">diff_img</span> <span class="o">=</span> <span class="n">FITSImageOnDisk</span><span class="p">(</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">diff_stamp_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">],</span>
                                    <span class="n">noisepath</span><span class="o">=</span><span class="n">sci_image</span><span class="o">.</span><span class="n">diff_var_stamp_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">psf_img</span> <span class="o">=</span> <span class="n">FITSImageOnDisk</span><span class="p">(</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_psf_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="p">)</span>

        <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;sci_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;templ_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">ra</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">dec</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">mjd</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;pointing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">pointing</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;sca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;template_pointing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">pointing</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;template_sca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Make sure the files are there.  Has side effect of loading the header and data.</span>
            <span class="n">diff_img</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
            <span class="n">diff_img</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;noise&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
            <span class="c1"># The thing written to disk was actually variance, so fix that</span>
            <span class="n">diff_img</span><span class="o">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">diff_img</span><span class="o">.</span><span class="n">noise</span> <span class="p">)</span>
            <span class="n">psf_img</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># TODO : change this to a more specific exception</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Post-processed image files for &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="si">}</span><span class="s2">-&quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="si">}</span><span class="s2"> &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;do not exist.  Skipping.&quot;</span> <span class="p">)</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;zpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;ap_zpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;flux_fit_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;mag_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;mag_fit_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;...make_phot_info_dict getting psf&quot;</span> <span class="p">)</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">ra</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">dec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="n">pxcoords</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span> <span class="n">coord</span><span class="p">,</span> <span class="n">diff_img</span><span class="o">.</span><span class="n">get_wcs</span><span class="p">()</span><span class="o">.</span><span class="n">get_astropy_wcs</span><span class="p">()</span> <span class="p">)</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">PSF</span><span class="o">.</span><span class="n">get_psf_object</span><span class="p">(</span> <span class="s1">&#39;OversampledImagePSF&#39;</span><span class="p">,</span>
                                  <span class="n">x</span><span class="o">=</span><span class="n">diff_img</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">diff_img</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span>
                                  <span class="n">oversample_factor</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                                  <span class="n">data</span><span class="o">=</span><span class="n">psf_img</span><span class="o">.</span><span class="n">data</span> <span class="p">)</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;...make_phot_info_dict doing photometry&quot;</span> <span class="p">)</span>
        <span class="n">results_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">phot_at_coords</span><span class="p">(</span> <span class="n">diff_img</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">pxcoords</span><span class="o">=</span><span class="n">pxcoords</span><span class="p">,</span> <span class="n">ap_r</span><span class="o">=</span><span class="n">ap_r</span><span class="p">)</span> <span class="p">)</span>

        <span class="c1"># Add additional info to the results dictionary so it can be merged into a nice file later.</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;...make_phot_info_dict getting zeropoint&quot;</span> <span class="p">)</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;zpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">zeropoint</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;...make_phot_info_dict done.&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">results_dict</span></div>


<div class="viewcode-block" id="Pipeline.add_to_results_dict">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline.add_to_results_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_to_results_dict</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">one_pair</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">one_pair</span><span class="p">[</span> <span class="n">key</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;Done adding to results dict&quot;</span> <span class="p">)</span></div>


<div class="viewcode-block" id="Pipeline.save_stamp_paths">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline.save_stamp_paths">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_stamp_paths</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">,</span> <span class="n">paths</span> <span class="p">):</span>
        <span class="n">sci_image</span><span class="o">.</span><span class="n">zpt_stamp_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sci_image</span><span class="o">.</span><span class="n">diff_stamp_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sci_image</span><span class="o">.</span><span class="n">diff_var_stamp_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span></div>


<div class="viewcode-block" id="Pipeline.do_stamps">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline.do_stamps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">do_stamps</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span> <span class="p">):</span>

        <span class="n">zptim</span> <span class="o">=</span> <span class="n">FITSImageOnDisk</span><span class="p">(</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_zptimg_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">zpt_stampname</span> <span class="o">=</span> <span class="n">stampmaker</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]),</span>
                                    <span class="n">zptim</span><span class="p">,</span>
                                    <span class="n">savedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span><span class="p">,</span>
                                    <span class="n">savename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;stamp_</span><span class="si">{</span><span class="n">zptim</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="n">zptim</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>

        <span class="n">diffim</span> <span class="o">=</span> <span class="n">FITSImageOnDisk</span><span class="p">(</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_diff_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">diff_stampname</span> <span class="o">=</span> <span class="n">stampmaker</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]),</span>
                                     <span class="n">diffim</span><span class="p">,</span>
                                     <span class="n">savedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span><span class="p">,</span>
                                     <span class="n">savename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;stamp_</span><span class="si">{</span><span class="n">diffim</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="n">diffim</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>

        <span class="n">diffvarim</span> <span class="o">=</span> <span class="n">FITSImageOnDisk</span><span class="p">(</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">diff_var_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="p">)</span>
        <span class="n">diffvar_stampname</span> <span class="o">=</span> <span class="n">stampmaker</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]),</span>
                                        <span class="n">diffvarim</span><span class="p">,</span>
                                        <span class="n">savedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span><span class="p">,</span>
                                        <span class="n">savename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;stamp_</span><span class="si">{</span><span class="n">diffvarim</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="n">diffvarim</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>

        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decorrelated diff stamp path: </span><span class="si">{</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="w"> </span><span class="n">diff_stampname</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Zpt image stamp path: </span><span class="si">{</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="w"> </span><span class="n">zpt_stampname</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decorrelated diff variance stamp path: </span><span class="si">{</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="w"> </span><span class="n">diffvar_stampname</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">zpt_stampname</span> <span class="p">),</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">diff_stampname</span> <span class="p">),</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">diffvar_stampname</span> <span class="p">)</span></div>


<div class="viewcode-block" id="Pipeline.make_lightcurve">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline.make_lightcurve">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_lightcurve</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Making lightcurve.&quot;</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ra&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;dec&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;mjd&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;filter&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;pointing&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;sca&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;template_pointing&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;template_sca&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;zpt&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;aperture_sum&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;flux_fit&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;flux_fit_err&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;mag_fit&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;mag_fit_err&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_omg</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span> <span class="n">x</span> <span class="p">):</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;make_phot_info_dict subprocess failure: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_omg</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sci_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">templ_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span><span class="p">:</span>
                        <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_phot_info_dict</span><span class="p">,</span> <span class="p">(</span><span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">),</span> <span class="p">{},</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">add_to_results_dict</span><span class="p">,</span>
                                          <span class="n">error_callback</span><span class="o">=</span><span class="n">log_error</span> <span class="p">)</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sci_image</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span> <span class="p">):</span>
                <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Doing science image </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">templ_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_results_dict</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_phot_info_dict</span><span class="p">(</span> <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omg</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="s2">&quot;make_phot_info_dict failed&quot;</span> <span class="p">)</span>

        <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s2">&quot;Saving results...&quot;</span> <span class="p">)</span>
        <span class="n">results_tab</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_dict</span><span class="p">)</span>
        <span class="n">results_tab</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span>
        <span class="n">results_savedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ltcv_dir</span> <span class="o">/</span> <span class="s1">&#39;data&#39;</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">results_savedir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="n">results_savepath</span> <span class="o">=</span> <span class="n">results_savedir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s1">_all.csv&#39;</span>
        <span class="n">results_tab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">results_savepath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Results saved to </span><span class="si">{</span><span class="n">results_savepath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results_savepath</span></div>


<div class="viewcode-block" id="Pipeline.write_fits_file">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline.write_fits_file">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">write_fits_file</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">savepath</span> <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Exception writing FITS image </span><span class="si">{</span><span class="n">savepath</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="k">raise</span></div>


<div class="viewcode-block" id="Pipeline.clear_contents">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline.clear_contents">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_contents</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">directory</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">directory</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span> <span class="n">f</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;Oops! Deleting </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> from </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1"> did not work.</span><span class="se">\n</span><span class="s1">Reason: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span></div>


<div class="viewcode-block" id="Pipeline.__call__">
<a class="viewcode-back" href="../../api/phrosty.pipeline.Pipeline.html#phrosty.pipeline.Pipeline.__call__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">through_step</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the pipeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          through_step: str, default None</span>
<span class="sd">             Which step to run thorough?  Runs them all if not given.</span>

<span class="sd">             Steps in order are:</span>
<span class="sd">             * sky_subtract</span>
<span class="sd">             * get_psfs</span>
<span class="sd">             * align_and_preconvolve</span>
<span class="sd">             * subtract</span>
<span class="sd">             * find_decorrelation</span>
<span class="sd">             * apply_decorrelation</span>
<span class="sd">             * make_stamps</span>
<span class="sd">             * make_lightcurve</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          ltcvpath : pathlib.Path or None</span>
<span class="sd">            The path to the output lightcurve file if make_lightcurve</span>
<span class="sd">            was run, otherwise None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span><span class="p">:</span>
            <span class="n">tracemalloc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">tracemalloc</span><span class="o">.</span><span class="n">reset_peak</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">through_step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">through_step</span> <span class="o">=</span> <span class="s1">&#39;make_lightcurve&#39;</span>

        <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;sky_subtract&#39;</span><span class="p">,</span> <span class="s1">&#39;get_psfs&#39;</span><span class="p">,</span> <span class="s1">&#39;align_and_preconvolve&#39;</span><span class="p">,</span> <span class="s1">&#39;subtract&#39;</span><span class="p">,</span> <span class="s1">&#39;find_decorrelation&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;apply_decorrelation&#39;</span><span class="p">,</span> <span class="s1">&#39;make_stamps&#39;</span><span class="p">,</span> <span class="s1">&#39;make_lightcurve&#39;</span> <span class="p">]</span>
        <span class="n">stepdex</span> <span class="o">=</span> <span class="n">steps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">through_step</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">stepdex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Unknown step </span><span class="si">{</span><span class="n">through_step</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[:</span><span class="n">stepdex</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;sky_subtract&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Running sky subtraction&quot;</span> <span class="p">)</span>
            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;skysub&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff8888</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sky_sub_all_images</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;After sky_subtract, memory usage = </span><span class="si">{</span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;get_psfs&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Getting PSFs&quot;</span> <span class="p">)</span>
            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;getpsfs&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff8888</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_psfs</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;After get_psfs, memory usage = </span><span class="si">{</span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span> <span class="p">)</span>

        <span class="c1"># Create a process pool to write fits files</span>
        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwrite</span> <span class="p">)</span> <span class="k">as</span> <span class="n">fits_writer_pool</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">log_fits_write_error</span><span class="p">(</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">x</span> <span class="p">):</span>
                <span class="n">SNLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Exception writing FITS file </span><span class="si">{</span><span class="n">savepath</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                <span class="c1"># raise?</span>

            <span class="c1"># Do the hardcore processing</span>

            <span class="k">for</span> <span class="n">templ_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sci_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="p">:</span>
                    <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> minus </span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                    <span class="n">sfftifier</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="s1">&#39;align_and_preconvolve&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;...align_and_preconvolve&quot;</span> <span class="p">)</span>
                        <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;align_and_pre_convolve&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0x8888ff</span> <span class="p">):</span>
                            <span class="n">sfftifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_and_pre_convolve</span><span class="p">(</span> <span class="n">templ_image</span><span class="p">,</span> <span class="n">sci_image</span> <span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;subtract&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;...subtract&quot;</span> <span class="p">)</span>
                        <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;subtraction&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0x44ccff</span> <span class="p">):</span>
                            <span class="n">sfftifier</span><span class="o">.</span><span class="n">sfft_subtraction</span><span class="p">()</span>

                    <span class="k">if</span> <span class="s1">&#39;find_decorrelation&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;...find_decorrelation&quot;</span> <span class="p">)</span>
                        <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;find_decor&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xcc44ff</span> <span class="p">):</span>
                            <span class="n">sfftifier</span><span class="o">.</span><span class="n">find_decorrelation</span><span class="p">()</span>

                        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;...generate variance image&quot;</span> <span class="p">)</span>
                        <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;variance&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0x44ccff</span> <span class="p">):</span>
                            <span class="n">diff_var</span> <span class="o">=</span> <span class="n">sfftifier</span><span class="o">.</span><span class="n">create_variance_image</span><span class="p">()</span>
                            <span class="n">mess</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="n">diff_var_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;diff_var_</span><span class="si">{</span><span class="n">mess</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="k">if</span> <span class="s1">&#39;apply_decorrelation&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="n">mess</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">decorr_psf_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;decorr_psf_</span><span class="si">{</span><span class="n">mess</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">decorr_zptimg_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;decorr_zptimg_</span><span class="si">{</span><span class="n">mess</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">decorr_diff_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;decorr_diff_</span><span class="si">{</span><span class="n">mess</span><span class="si">}</span><span class="s2">&quot;</span>

                        <span class="n">images</span> <span class="o">=</span>    <span class="p">[</span> <span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_DIFF_GPU</span><span class="p">,</span>    <span class="n">diff_var</span><span class="p">,</span>
                                      <span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_Ctarget_GPU</span><span class="p">,</span> <span class="n">sfftifier</span><span class="o">.</span><span class="n">PSF_target_GPU</span> <span class="p">]</span>
                        <span class="n">savepaths</span> <span class="o">=</span> <span class="p">[</span> <span class="n">decorr_diff_path</span><span class="p">,</span>           <span class="n">diff_var_path</span><span class="p">,</span>
                                      <span class="n">decorr_zptimg_path</span><span class="p">,</span>         <span class="n">decorr_psf_path</span> <span class="p">]</span>
                        <span class="n">headers</span> <span class="o">=</span>   <span class="p">[</span> <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">,</span>       <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">,</span>
                                      <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">,</span>       <span class="kc">None</span> <span class="p">]</span>

                        <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span> <span class="n">images</span><span class="p">,</span> <span class="n">savepaths</span><span class="p">,</span> <span class="n">headers</span> <span class="p">):</span>
                            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;apply_decor&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xccccff</span> <span class="p">):</span>
                                <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;...apply_decor to </span><span class="si">{</span><span class="n">savepath</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                                <span class="n">decorimg</span> <span class="o">=</span> <span class="n">sfftifier</span><span class="o">.</span><span class="n">apply_decorrelation</span><span class="p">(</span> <span class="n">img</span> <span class="p">)</span>
                            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;submit writefits&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff8888</span> <span class="p">):</span>
                                <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;...writefits </span><span class="si">{</span><span class="n">savepath</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                                <span class="n">fits_writer_pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_fits_file</span><span class="p">,</span>
                                                              <span class="p">(</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span> <span class="n">decorimg</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">savepath</span> <span class="p">),</span> <span class="p">{},</span>
                                                              <span class="n">error_callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">log_fits_write_error</span><span class="p">,</span> <span class="n">savepath</span><span class="p">)</span> <span class="p">)</span>
                        <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_psf_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">decorr_psf_path</span>
                        <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_zptimg_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">decorr_zptimg_path</span>
                        <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_diff_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">decorr_diff_path</span>
                        <span class="n">sci_image</span><span class="o">.</span><span class="n">diff_var_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">diff_var_path</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span><span class="p">:</span>
                        <span class="c1"># Each key is the file prefix addition.</span>
                        <span class="c1"># Each list has [descriptive filetype, image file name, data, header].</span>

                        <span class="c1"># TODO: Include multiprocessing.</span>
                        <span class="c1"># In the future, we may want to write these things right after they happen</span>
                        <span class="c1"># instead of saving it all for the end of the SFFT stuff.</span>

                        <span class="n">write_filepaths</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aligned&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span>
                                                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                        <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_resamp_object_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                        <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">],</span>
                                                        <span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">,</span>
                                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                         <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_resamp_objectVar_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                         <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">],</span>
                                                       <span class="p">[</span><span class="s1">&#39;psf&#39;</span><span class="p">,</span>
                                                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                        <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PSF_resamp_object_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                        <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">],</span>
                                                       <span class="p">[</span><span class="s1">&#39;detmask&#39;</span><span class="p">,</span>
                                                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                        <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_resamp_object_DMASK_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                        <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">]</span>
                                                       <span class="p">],</span>
                                           <span class="s1">&#39;convolved&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span>
                                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                         <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_Ctarget_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                         <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">],</span>
                                                         <span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span>
                                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                         <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_Cresamp_object_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                         <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">]</span>
                                                        <span class="p">],</span>
                                           <span class="s1">&#39;diff&#39;</span><span class="p">:</span>     <span class="p">[[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span>
                                                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                        <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_DIFF_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                        <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">]</span>
                                                       <span class="p">],</span>
                                           <span class="s1">&#39;decorr&#39;</span><span class="p">:</span>   <span class="p">[[</span><span class="s1">&#39;kernel&#39;</span><span class="p">,</span>
                                                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                        <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">FKDECO_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                        <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">]</span>
                                                       <span class="p">]</span>
                                          <span class="p">}</span>
                        <span class="c1"># Write the aligned images</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">write_filepaths</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">for</span> <span class="p">(</span><span class="n">imgtype</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span> <span class="ow">in</span> <span class="n">write_filepaths</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                                <span class="n">savepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scratch_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">imgtype</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">write_fits_file</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">savepath</span> <span class="p">)</span>

                    <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;DONE processing </span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> minus </span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span><span class="p">:</span>
                        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;After preprocessing, subtracting, and postprocessing </span><span class="se">\</span>
<span class="s2">                                        a science image, memory usage = </span><span class="se">\</span>
<span class="s2">                                         </span><span class="si">{</span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span> <span class="p">)</span>

                    <span class="n">sci_image</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>

                <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;DONE with all science images for template </span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                <span class="n">templ_image</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>

            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Waiting for FITS writer processes to finish&quot;</span> <span class="p">)</span>
            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;fits_write_wait&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff8888</span> <span class="p">):</span>
                <span class="n">fits_writer_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">fits_writer_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;...FITS writer processes done.&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;make_stamps&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Starting to make stamps...&quot;</span> <span class="p">)</span>
            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;make stamps&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff8888</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_omg</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">log_stamp_err</span><span class="p">(</span> <span class="n">x</span> <span class="p">):</span>
                    <span class="n">SNLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;do_stamps subprocess failure: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_omg</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">partialstamp</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">stampmaker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diaobj</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]))</span>
                <span class="c1"># template path, savedir, savename</span>
                <span class="n">templstamp_args</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;stamp_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span> <span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwrite</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwrite</span> <span class="p">)</span> <span class="k">as</span> <span class="n">templ_stamp_pool</span><span class="p">:</span>
                        <span class="n">templ_stamp_pool</span><span class="o">.</span><span class="n">starmap_async</span><span class="p">(</span> <span class="n">partialstamp</span><span class="p">,</span> <span class="n">templstamp_args</span><span class="p">,</span>
                                                        <span class="n">error_callback</span><span class="o">=</span><span class="n">log_stamp_err</span> <span class="p">)</span>
                        <span class="n">templ_stamp_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">templ_stamp_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

                    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwrite</span> <span class="p">)</span> <span class="k">as</span> <span class="n">sci_stamp_pool</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">sci_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">templ_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span><span class="p">:</span>
                                <span class="n">pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">)</span>
                                <span class="n">sci_stamp_pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_stamps</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="p">{},</span>
                                                            <span class="n">callback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_stamp_paths</span><span class="p">,</span>
                                                                               <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">),</span>
                                                            <span class="n">error_callback</span><span class="o">=</span><span class="n">log_stamp_err</span> <span class="p">)</span>
                        <span class="n">sci_stamp_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">sci_stamp_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tsargs</span> <span class="ow">in</span> <span class="n">templstamp_args</span><span class="p">:</span>
                        <span class="n">partialstamp</span><span class="p">(</span><span class="o">*</span><span class="n">tsargs</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">sci_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">templ_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span><span class="p">:</span>
                            <span class="n">stamp_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_stamps</span><span class="p">(</span> <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">save_stamp_paths</span><span class="p">(</span> <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">,</span> <span class="n">stamp_paths</span> <span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omg</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="s2">&quot;Error making stamps.&quot;</span> <span class="p">)</span>

            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...finished making stamps.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;After make_stamps, memory usage = </span><span class="si">{</span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span> <span class="p">)</span>

        <span class="n">lightcurve_path</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;make_lightcurve&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;make_lightcurve&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff8888</span> <span class="p">):</span>
                <span class="n">lightcurve_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_lightcurve</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;After make_lightcurve, memory usage = </span><span class="se">\</span>
<span class="s2">                            </span><span class="si">{</span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_temp_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_contents</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">lightcurve_path</span></div>
</div>



<span class="c1"># ======================================================================</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Run one arg pass just to get the config file, so we can augment</span>
    <span class="c1">#   the full arg parser later with config options</span>
    <span class="n">configparser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span> <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
    <span class="n">configparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--config-file&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="p">(</span> <span class="s2">&quot;Location of the .yaml config file; defaults to the value of the &quot;</span>
                                      <span class="s2">&quot;SNPIT_CONFIG environment varaible.&quot;</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">leftovers</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">config_file</span><span class="p">,</span> <span class="n">setdefault</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;No default config defined yet; run Config.init(configfile)&#39;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;Error, no configuration file defined.</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot;Either run phrosty with -c &lt;configfile&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot;or set the SNPIT_CONFIG environment variable.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="c1"># Put in the config_file argument, even though it will never be found, so it shows up in help</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--config-file&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Location of the .yaml config file&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;--object-collection&#39;</span><span class="p">,</span> <span class="s1">&#39;--oc&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Collection of the object.  Currently only &quot;ou2024&quot; and &quot;manual&quot; supported.&#39;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;--object-subset&#39;</span><span class="p">,</span> <span class="s1">&#39;--os&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Collection subset.  Not used by all collections.&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;--oid&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Object ID.  Meaning is collection-dependent.&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--ra&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Object RA.  By default, uses the one found for the object.&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--dec&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Object Dec.  By default, uses the one found for the object.&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--band&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Band: R062, Z087, Y106, J129, H158, F184, or K213&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;--image-collection&#39;</span><span class="p">,</span> <span class="s1">&#39;--ic&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Collection of the images we&#39;re using&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;--image-subset&#39;</span><span class="p">,</span> <span class="s1">&#39;--is&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Image collection subset&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;--base-path&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Base path for images.  Required for &quot;manual_fits&quot; image collection&#39;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--template-images&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to file with, per line, ( path_to_image, pointing, sca, mjd, band )&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--science-images&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to file with, per line, ( path_to_image, pointing, sca, mjd, band )&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--nprocs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of process for multiprocessing steps (e.g. skysub)&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="s1">&#39;--nwrite&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of parallel FITS writing processes&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show debug log info&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;--through-step&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;make_lightcurve&#39;</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stop after this step; one of (see above)&quot;</span> <span class="p">)</span>

    <span class="n">cfg</span><span class="o">.</span><span class="n">augment_argparse</span><span class="p">(</span> <span class="n">parser</span> <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span> <span class="n">leftovers</span> <span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span> <span class="n">args</span> <span class="p">)</span>

    <span class="c1"># Get the DiaObject, update the RA and Dec</span>

    <span class="n">diaobjs</span> <span class="o">=</span> <span class="n">DiaObject</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span> <span class="n">collection</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">object_collection</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">object_subset</span><span class="p">,</span>
                                      <span class="nb">id</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">oid</span><span class="p">,</span> <span class="n">ra</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dec</span> <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">diaobjs</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Could not find DiaObject with id=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, ra=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">ra</span><span class="si">}</span><span class="s2">, dec=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">dec</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">diaobjs</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Found multiple DiaObject with id=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, ra=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">ra</span><span class="si">}</span><span class="s2">, dec=</span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">dec</span><span class="si">}</span><span class="s2">.&quot;</span> <span class="p">)</span>
    <span class="n">diaobj</span> <span class="o">=</span> <span class="n">diaobjs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">ra</span> <span class="o">-</span> <span class="n">diaobj</span><span class="o">.</span><span class="n">ra</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">3600.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span> <span class="n">diaobj</span><span class="o">.</span><span class="n">dec</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span> <span class="p">):</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Given RA </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">ra</span><span class="si">}</span><span class="s2"> is far from DiaObject nominal RA </span><span class="si">{</span><span class="n">diaobj</span><span class="o">.</span><span class="n">ra</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="n">diaobj</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">ra</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">dec</span> <span class="o">-</span> <span class="n">diaobj</span><span class="o">.</span><span class="n">dec</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">3600.</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Given Dec </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">dec</span><span class="si">}</span><span class="s2"> is far from DiaObject nominal Dec </span><span class="si">{</span><span class="n">diaobj</span><span class="o">.</span><span class="n">dec</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="n">diaobj</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">dec</span>

    <span class="c1"># Get the image collection</span>

    <span class="n">imgcol</span> <span class="o">=</span> <span class="n">ImageCollection</span><span class="o">.</span><span class="n">get_collection</span><span class="p">(</span> <span class="n">collection</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">image_collection</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">image_subset</span><span class="p">,</span>
                                             <span class="n">base_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">base_path</span> <span class="p">)</span>

    <span class="c1"># Create and launch the pipeline</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span> <span class="n">diaobj</span><span class="p">,</span> <span class="n">imgcol</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">band</span><span class="p">,</span>
                         <span class="n">science_csv</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">science_images</span><span class="p">,</span> <span class="n">template_csv</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">template_images</span><span class="p">,</span>
                         <span class="n">nprocs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">nwrite</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">nwrite</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="p">)</span>
    <span class="n">pipeline</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">through_step</span> <span class="p">)</span>


<span class="c1"># ======================================================================</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2025, Roman Supernova PIT.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>