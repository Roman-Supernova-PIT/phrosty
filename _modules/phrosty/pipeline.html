<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>phrosty.pipeline &#8212; phrosty 0.1.dev1+g9c64133 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=5a6b8c39" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=f3bc516d" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <script src="../../_static/documentation_options.js?v=a1f0b140"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/logo_black_filled.png" alt="Logo" />
    
  </a>
</p>



<p class="blurb">Software developed by the Roman SNPIT</p>






<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">phrosty API</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <h1>Source code for phrosty.pipeline</h1><div class="highlight"><pre>
<span></span><span class="c1"># Imports STANDARD</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cupy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">nvtx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tracemalloc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="c1"># Imports ASTRO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.table</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.wcs</span><span class="w"> </span><span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.wcs.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">skycoord_to_pixel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">galsim</span><span class="w"> </span><span class="kn">import</span> <span class="n">roman</span>

<span class="c1"># Imports INTERNAL</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">phrosty.imagesubtraction</span><span class="w"> </span><span class="kn">import</span> <span class="n">sky_subtract</span><span class="p">,</span> <span class="n">stampmaker</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">phrosty.photometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">ap_phot</span><span class="p">,</span> <span class="n">psfmodel</span><span class="p">,</span> <span class="n">psf_phot</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">phrosty.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_exptime</span><span class="p">,</span> <span class="n">read_truth_txt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sfft.SpaceSFFTCupyFlow</span><span class="w"> </span><span class="kn">import</span> <span class="n">SpaceSFFT_CupyFlow</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.image</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenUniverse2024FITSImage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snappl.psf</span><span class="w"> </span><span class="kn">import</span> <span class="n">PSF</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snpit_utils.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">snpit_utils.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">SNLogger</span>


<div class="viewcode-block" id="PipelineImage">
<a class="viewcode-back" href="../../api.html#phrosty.pipeline.PipelineImage">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">PipelineImage</span><span class="p">:</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;Holds a snappl.image.Image, with some other stuff the pipeline needs.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">imagepath</span><span class="p">,</span> <span class="n">pointing</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">pipeline</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a PipelineImage</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">           imagepath : str or Path</span>
<span class="sd">              A path to the image.  This will be passed on to an Image</span>
<span class="sd">              subclass constructor; which subclass depends on the config</span>
<span class="sd">              option photometry.phrosty.image_type</span>

<span class="sd">           pointing : str or int</span>
<span class="sd">              An identifier of the pointing of this image.  Used e.g. to pull PSFs.</span>

<span class="sd">           pipeline : phrosty.pipeline.Pipeline</span>
<span class="sd">              The pipeline that owns this image.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.psf is a object of a subclass of snappl.psf.PSF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">temp_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.keep_intermediate&#39;</span> <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.paths.scratch_dir&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.image_type&#39;</span> <span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ou2024fits&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">OpenUniverse2024FITSImage</span><span class="p">(</span> <span class="n">imagepath</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sca</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span> <span class="s2">&quot;At the moment, phrosty only works with ou2024fits images. &quot;</span>
                                <span class="s2">&quot;We hope this will change soon.&quot;</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pointing</span> <span class="o">=</span> <span class="n">pointing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">band</span>

        <span class="c1"># Intermediate files</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span><span class="p">:</span>
            <span class="c1"># Set to None. The path gets defined later on.</span>
            <span class="c1"># They have to be defined here in __init__ so that they exist</span>
            <span class="c1"># and are accessible in later functions.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skysub_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detmask_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_sci_psf_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_templ_psf_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_templ_img_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_templ_var_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aligned_templ_psf_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crossconv_sci_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">crossconv_templ_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diff_path</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decorr_kernel_path</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Always save and output these</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorr_psf_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorr_zptimg_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decorr_diff_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zpt_stamp_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_var_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_var_stamp_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_stamp_path</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Held in memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyrms</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psfobj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_data</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_sky_subtract</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">mp</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
        <span class="c1"># Eventually, we may not want to save the sky subtracted image, but keep</span>
        <span class="c1">#   it in memory.  (Reduce I/O.)  Will require SFFT changes.</span>
        <span class="c1">#   (This may not be practical, as it will increase memory usage a *lot*.</span>
        <span class="c1">#   We may still need to write files.)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">imname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span>
            <span class="c1"># HACK ALERT : we&#39;re stripping the .gz off of the end of filenames</span>
            <span class="c1">#   if they have them, and making sure filenames end in .fits,</span>
            <span class="c1">#   because that&#39;s what SFFT needs.  This can go away if we</span>
            <span class="c1">#   refactor to pass data.</span>
            <span class="k">if</span> <span class="n">imname</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
                <span class="n">imname</span> <span class="o">=</span> <span class="n">imname</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">imname</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.fits&#39;</span><span class="p">:</span>
                <span class="n">imname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">imname</span><span class="si">}</span><span class="s1">.fits&#39;</span>
            <span class="c1"># Hey Rob--the below is broken. The pipeline runs with mp if I use the</span>
            <span class="c1"># example science image file from examples/perlmutter, but not if I use</span>
            <span class="c1"># my own file. If I run with one process, my own file runs.</span>
            <span class="c1"># if mp:</span>
            <span class="c1">#     SNLogger.multiprocessing_replace()</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;run_sky_subtract on </span><span class="si">{</span><span class="n">imname</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">skysub_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;skysub_</span><span class="si">{</span><span class="n">imname</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detmask_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;detmask_</span><span class="si">{</span><span class="n">imname</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skyrms</span> <span class="o">=</span> <span class="n">sky_subtract</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detmask_path</span><span class="p">,</span> <span class="n">temp_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span>
                                        <span class="n">force</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.force_sky_subtract&#39;</span> <span class="p">)</span> <span class="p">)</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;...done running sky subtraction on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">skysub_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detmask_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyrms</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span> <span class="n">ex</span> <span class="p">)</span>
            <span class="k">raise</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_sky_subtract_info</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">info</span> <span class="p">):</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Saving sky_subtract info for path </span><span class="si">{</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skysub_path</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detmask_path</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyrms</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<div class="viewcode-block" id="PipelineImage.get_psf">
<a class="viewcode-back" href="../../api.html#phrosty.pipeline.PipelineImage.get_psf">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_psf</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the at the right spot on the image.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          ra, dec : float</span>
<span class="sd">             The coordinates in decimal degrees where we want the PSF.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: right now snappl.psf.PSF.get_psf_object just</span>
        <span class="c1">#   passes the keyword arguments on to whatever makes</span>
        <span class="c1">#   the psf... and it&#39;s different for each type of</span>
        <span class="c1">#   PSF.  We need to fix that... somehow....</span>

        <span class="n">wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">get_wcs</span><span class="p">()</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psfobj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psftype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.psf.type&#39;</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psfobj</span> <span class="o">=</span> <span class="n">PSF</span><span class="o">.</span><span class="n">get_psf_object</span><span class="p">(</span> <span class="n">psftype</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="n">pointing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pointing</span><span class="p">,</span> <span class="n">sca</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="p">,</span>
                                              <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span> <span class="p">)</span>

        <span class="n">stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psfobj</span><span class="o">.</span><span class="n">get_stamp</span><span class="p">(</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span><span class="p">:</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;psf_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.fits&quot;</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">stamp</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">stamp</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">keep_psf_data</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">psf_data</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_data</span> <span class="o">=</span> <span class="n">psf_data</span>

<div class="viewcode-block" id="PipelineImage.free">
<a class="viewcode-back" href="../../api.html#phrosty.pipeline.PipelineImage.free">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">free</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Try to free memory.  More might be done here.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">free</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="Pipeline">
<a class="viewcode-back" href="../../api.html#phrosty.pipeline.Pipeline">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Pipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Phrosty&#39;s top-level pipeline&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">object_id</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">science_images</span><span class="p">,</span> <span class="n">template_images</span><span class="p">,</span> <span class="n">nprocs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nwrite</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the a pipeline object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">           object_id: int</span>

<span class="sd">           ra, dec: float</span>
<span class="sd">             Position of transient in decimal degrees</span>

<span class="sd">           band: str</span>
<span class="sd">             One of R062, Z087, Y106, J129, H158, F184, K213</span>

<span class="sd">           science_images: list of tuple</span>
<span class="sd">               ( path_to_image, pointing, sca )</span>

<span class="sd">           template_images: list of tuple</span>
<span class="sd">               ( path_to_image, pointing, sca )</span>

<span class="sd">           nprocs: int, default 1</span>
<span class="sd">             Number of cpus for the CPU multiprocessing segments of the pipeline.</span>
<span class="sd">             (GPU segments will run a single process.)</span>

<span class="sd">           nwrite: int, default 5</span>
<span class="sd">             Number of asynchronous FITS writer processes.</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">SNLogger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tds_base_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;ou24.tds_base&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_base_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tds_base_dir</span> <span class="o">/</span> <span class="s1">&#39;images&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.paths.dia_out_dir&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scratch_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.paths.scratch_dir&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir_parent</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.paths.temp_dir&#39;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir_parent</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid1</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ltcv_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.paths.ltcv_dir&#39;</span> <span class="p">)</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">object_id</span> <span class="o">=</span> <span class="n">object_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="n">dec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">band</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span> <span class="o">=</span> <span class="p">(</span> <span class="p">[</span> <span class="n">PipelineImage</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_base_dir</span> <span class="o">/</span> <span class="n">ppsmb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ppsmb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ppsmb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span> <span class="p">)</span>
                                  <span class="k">for</span> <span class="n">ppsmb</span> <span class="ow">in</span> <span class="n">science_images</span> <span class="k">if</span> <span class="n">ppsmb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span> <span class="o">=</span> <span class="p">(</span> <span class="p">[</span> <span class="n">PipelineImage</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_base_dir</span> <span class="o">/</span> <span class="n">ppsmb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ppsmb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ppsmb</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span> <span class="p">)</span>
                                   <span class="k">for</span> <span class="n">ppsmb</span> <span class="ow">in</span> <span class="n">template_images</span> <span class="k">if</span> <span class="n">ppsmb</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span> <span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">=</span> <span class="n">nprocs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nwrite</span> <span class="o">=</span> <span class="n">nwrite</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.keep_intermediate&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_temp_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.remove_temp_dir&#39;</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">value</span><span class="p">(</span> <span class="s1">&#39;photometry.phrosty.mem_trace&#39;</span> <span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">sky_sub_all_images</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="c1"># Currently, this writes out a bunch of FITS files.  Further refactoring needed</span>
        <span class="c1">#   to support more general image types.</span>
        <span class="n">all_imgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>     <span class="c1"># shallow copy</span>
        <span class="n">all_imgs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span> <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">log_error</span><span class="p">(</span> <span class="n">img</span><span class="p">,</span> <span class="n">x</span> <span class="p">):</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Sky subtraction subprocess failure: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2"> for image </span><span class="si">{</span><span class="n">img</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">all_imgs</span><span class="p">:</span>

                    <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span> <span class="n">img</span><span class="o">.</span><span class="n">run_sky_subtract</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{},</span>
                                      <span class="n">callback</span><span class="o">=</span><span class="n">img</span><span class="o">.</span><span class="n">save_sky_subtract_info</span><span class="p">,</span>
                                      <span class="n">error_callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">log_error</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">all_imgs</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">save_sky_subtract_info</span><span class="p">(</span> <span class="n">img</span><span class="o">.</span><span class="n">run_sky_subtract</span><span class="p">(</span> <span class="n">mp</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span> <span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_psfs</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">all_imgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>     <span class="c1"># shallow copy</span>
        <span class="n">all_imgs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">all_imgs</span><span class="p">:</span>
                    <span class="c1"># callback_partial = partial( img.save_psf_path, all_imgs )</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span> <span class="n">img</span><span class="o">.</span><span class="n">get_psf</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">),</span> <span class="p">{},</span>
                                      <span class="n">img</span><span class="o">.</span><span class="n">keep_psf_data</span><span class="p">,</span>
                                      <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">SNLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;get_psf subprocess failure: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span> <span class="p">)</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">all_imgs</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">keep_psf_data</span><span class="p">(</span> <span class="n">img</span><span class="o">.</span><span class="n">get_psf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span> <span class="p">)</span>


<div class="viewcode-block" id="Pipeline.align_and_pre_convolve">
<a class="viewcode-back" href="../../api.html#phrosty.pipeline.Pipeline.align_and_pre_convolve">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">align_and_pre_convolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">,</span> <span class="n">sci_image</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Align and pre convolve a single template/science pair.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          sci_image: phrosty.Image</span>
<span class="sd">            The science (new) image.</span>

<span class="sd">          templ_image: phrosty.Image</span>
<span class="sd">            The template (ref) image that will be subtracted from sci_image.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">skysub_path</span> <span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
            <span class="n">hdr_sci</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="n">data_sci</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span> <span class="p">)</span>
        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">skysub_path</span> <span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
            <span class="n">hdr_templ</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
            <span class="n">data_templ</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span> <span class="p">)</span>

        <span class="n">sci_psf</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">psf_data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">templ_psf</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">psf_data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">float64</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">detmask_path</span> <span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
            <span class="n">sci_detmask</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span> <span class="p">)</span> <span class="p">)</span>

        <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">detmask_path</span> <span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
            <span class="n">templ_detmask</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span> <span class="p">)</span> <span class="p">)</span>

        <span class="n">sfftifier</span> <span class="o">=</span> <span class="n">SpaceSFFT_CupyFlow</span><span class="p">(</span>
            <span class="n">hdr_sci</span><span class="p">,</span> <span class="n">hdr_templ</span><span class="p">,</span>
            <span class="n">sci_image</span><span class="o">.</span><span class="n">skyrms</span><span class="p">,</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">skyrms</span><span class="p">,</span>
            <span class="n">data_sci</span><span class="p">,</span> <span class="n">data_templ</span><span class="p">,</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">noise</span> <span class="p">),</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">noise</span> <span class="p">),</span>
            <span class="n">sci_detmask</span><span class="p">,</span> <span class="n">templ_detmask</span><span class="p">,</span>
            <span class="n">sci_psf</span><span class="p">,</span> <span class="n">templ_psf</span><span class="p">,</span>
            <span class="n">KerPolyOrder</span><span class="o">=</span><span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;photometry.phrosty.kerpolyorder&#39;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">sfftifier</span><span class="o">.</span><span class="n">resampling_image_mask_psf</span><span class="p">()</span>
        <span class="n">sfftifier</span><span class="o">.</span><span class="n">cross_convolution</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">sfftifier</span></div>


<div class="viewcode-block" id="Pipeline.phot_at_coords">
<a class="viewcode-back" href="../../api.html#phrosty.pipeline.Pipeline.phot_at_coords">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">phot_at_coords</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">pxcoords</span><span class="o">=</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">ap_r</span><span class="o">=</span><span class="mi">4</span> <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do photometry at forced set of pixel coordinates.&quot;&quot;&quot;</span>

        <span class="n">forcecoords</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([[</span><span class="nb">float</span><span class="p">(</span><span class="n">pxcoords</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">pxcoords</span><span class="p">[</span><span class="mi">1</span><span class="p">])]],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
        <span class="n">init</span> <span class="o">=</span> <span class="n">ap_phot</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">forcecoords</span><span class="p">,</span> <span class="n">ap_r</span><span class="o">=</span><span class="n">ap_r</span><span class="p">)</span>
        <span class="n">init</span><span class="p">[</span><span class="s1">&#39;flux_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">init</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span>
        <span class="n">final</span> <span class="o">=</span> <span class="n">psf_phot</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">forced_phot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">flux</span> <span class="o">=</span> <span class="n">final</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">flux_err</span> <span class="o">=</span> <span class="n">final</span><span class="p">[</span><span class="s1">&#39;flux_err&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">final</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">mag_err</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">final</span><span class="p">[</span><span class="s2">&quot;flux_err&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">final</span><span class="p">[</span><span class="s2">&quot;flux_fit&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;aperture_sum&#39;</span><span class="p">:</span> <span class="n">init</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s1">&#39;flux_fit&#39;</span><span class="p">:</span> <span class="n">flux</span><span class="p">,</span>
                        <span class="s1">&#39;flux_fit_err&#39;</span><span class="p">:</span> <span class="n">flux_err</span><span class="p">,</span>
                        <span class="s1">&#39;mag_fit&#39;</span><span class="p">:</span> <span class="n">mag</span><span class="p">,</span>
                        <span class="s1">&#39;mag_fit_err&#39;</span><span class="p">:</span> <span class="n">mag_err</span>
                        <span class="p">}</span>

        <span class="k">return</span> <span class="n">results_dict</span></div>


<div class="viewcode-block" id="Pipeline.get_stars">
<a class="viewcode-back" href="../../api.html#phrosty.pipeline.Pipeline.get_stars">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_stars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">truthpath</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="mi">4088</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="mi">4088</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the stars in the science images.</span>

<span class="sd">        Optional to transform to another WCS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">truth_tab</span> <span class="o">=</span> <span class="n">read_truth_txt</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">truthpath</span><span class="p">)</span>
        <span class="n">truth_tab</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;mag_truth&#39;</span>
        <span class="n">truth_tab</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;flux_truth&#39;</span>

        <span class="k">if</span> <span class="n">transform</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">wcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;You need to provide a WCS to transform to!&#39;</span>
            <span class="n">truth_tab</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">truth_tab</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;x_orig&#39;</span><span class="p">,</span> <span class="s1">&#39;y_orig&#39;</span>
            <span class="n">worldcoords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">truth_tab</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">truth_tab</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span><span class="n">worldcoords</span><span class="p">,</span> <span class="n">wcs</span><span class="p">)</span>
            <span class="n">truth_tab</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">truth_tab</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">transform</span><span class="p">:</span>
            <span class="n">truth_tab</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">truth_tab</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">truth_tab</span><span class="p">[</span><span class="s1">&#39;obj_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;star&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">truth_tab</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nx</span><span class="p">,</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">stars</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">stars</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ny</span><span class="p">,</span> <span class="n">stars</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">stars</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">get_galsim_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exptime</span> <span class="o">=</span> <span class="n">get_exptime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">)</span>
        <span class="n">area_eff</span> <span class="o">=</span> <span class="n">roman</span><span class="o">.</span><span class="n">collecting_area</span>
        <span class="n">gs_zpt</span> <span class="o">=</span> <span class="n">roman</span><span class="o">.</span><span class="n">getBandpasses</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">]</span><span class="o">.</span><span class="n">zeropoint</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;exptime&#39;</span><span class="p">:</span> <span class="n">exptime</span><span class="p">,</span> <span class="s1">&#39;area_eff&#39;</span><span class="p">:</span> <span class="n">area_eff</span><span class="p">,</span> <span class="s1">&#39;gs_zpt&#39;</span><span class="p">:</span> <span class="n">gs_zpt</span><span class="p">}</span>

<div class="viewcode-block" id="Pipeline.get_zpt">
<a class="viewcode-back" href="../../api.html#phrosty.pipeline.Pipeline.get_zpt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_zpt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zptimg</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">ap_r</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">zpt_plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">oid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sci_pointing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sci_sca</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># TODO : Need to move this code all over into snappl Image.  It sounds like</span>
        <span class="c1">#   for Roman images we may have to do our own zeropoints (which is what</span>
        <span class="c1">#   is happening here), but for actual Roman we&#39;re going to use</span>
        <span class="c1">#   calibration information we get from elsewhere, so we don&#39;t want to bake</span>
        <span class="c1">#   doing the calibration into the pipeline as we do here.</span>
        <span class="c1">#</span>
        <span class="c1"># Also Issue #70</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the zeropoint based on the stars.&quot;&quot;&quot;</span>

        <span class="c1"># First, need to do photometry on the stars.</span>
        <span class="n">init_params</span> <span class="o">=</span> <span class="n">ap_phot</span><span class="p">(</span><span class="n">zptimg</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">ap_r</span><span class="o">=</span><span class="n">ap_r</span><span class="p">)</span>
        <span class="n">init_params</span><span class="p">[</span><span class="s1">&#39;flux_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">init_params</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span>
        <span class="n">final_params</span> <span class="o">=</span> <span class="n">psf_phot</span><span class="p">(</span><span class="n">zptimg</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">init_params</span><span class="p">,</span> <span class="n">forced_phot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Do not need to cross match. Can just merge tables because they</span>
        <span class="c1"># will be in the same order.</span>
        <span class="n">photres</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stars</span><span class="p">,</span> <span class="n">init_params</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;object_id&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;realized_flux&#39;</span><span class="p">,</span>
                                                               <span class="s1">&#39;flux_truth&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_truth&#39;</span><span class="p">,</span> <span class="s1">&#39;obj_type&#39;</span><span class="p">])</span>
        <span class="n">photres</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">photres</span><span class="p">,</span> <span class="n">final_params</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

        <span class="c1"># Get the zero point.</span>
        <span class="n">galsim_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_galsim_values</span><span class="p">()</span>
        <span class="n">star_ap_mags</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">photres</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">])</span>
        <span class="n">star_fit_mags</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">photres</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">])</span>
        <span class="n">star_truth_mags</span> <span class="o">=</span> <span class="p">(</span> <span class="o">-</span><span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">photres</span><span class="p">[</span><span class="s1">&#39;flux_truth&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">galsim_vals</span><span class="p">[</span><span class="s1">&#39;gs_zpt&#39;</span><span class="p">]</span>
                            <span class="o">+</span> <span class="mf">2.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">galsim_vals</span><span class="p">[</span><span class="s1">&#39;exptime&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">galsim_vals</span><span class="p">[</span><span class="s1">&#39;area_eff&#39;</span><span class="p">])</span> <span class="p">)</span>

        <span class="c1"># Eventually, this should be a S/N cut, not a mag cut.</span>
        <span class="n">zpt_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">star_truth_mags</span> <span class="o">&gt;</span> <span class="mi">19</span><span class="p">,</span> <span class="n">star_truth_mags</span> <span class="o">&lt;</span> <span class="mf">21.5</span><span class="p">)</span>
        <span class="n">zpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">star_truth_mags</span><span class="p">[</span><span class="n">zpt_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">star_fit_mags</span><span class="p">[</span><span class="n">zpt_mask</span><span class="p">])</span>
        <span class="n">ap_zpt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">star_truth_mags</span><span class="p">[</span><span class="n">zpt_mask</span><span class="p">]</span> <span class="o">-</span> <span class="n">star_ap_mags</span><span class="p">[</span><span class="n">zpt_mask</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">zpt_plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">oid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;If zpt_plot=True, oid must be provided.&#39;</span>
            <span class="k">assert</span> <span class="n">sci_pointing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;If zpt_plot=True, sci_pointing must be provided.&#39;</span>
            <span class="k">assert</span> <span class="n">sci_sca</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;If zpt_plot=True, sci_sca must be provided.&#39;</span>

            <span class="n">savedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ltcv_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;figs/</span><span class="si">{</span><span class="n">oid</span><span class="si">}</span><span class="s1">/zpt_plots&#39;</span>
            <span class="n">savedir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">savepath</span> <span class="o">=</span> <span class="n">savedir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;zpt_stars_</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sci_pointing</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sci_sca</span><span class="si">}</span><span class="s1">.png&#39;</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
            <span class="n">yaxis</span> <span class="o">=</span> <span class="n">star_fit_mags</span> <span class="o">+</span> <span class="n">zpt</span> <span class="o">-</span> <span class="n">star_truth_mags</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">star_truth_mags</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Truth mag&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fit mag - zpt + truth mag&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">sci_pointing</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">sci_sca</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;zpt debug plot saved to </span><span class="si">{</span><span class="n">savepath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># savepath = os.path.join(savedir, f&#39;hist_truth-fit_{band}_{sci_pointing}_{sci_sca}.png&#39;)</span>
            <span class="c1"># plt.hist(star_truth_mags[zpt_mask] - star_fit_mags[zpt_mask])</span>
            <span class="c1"># plt.title(f&#39;{band} {sci_pointing} {sci_sca}&#39;)</span>
            <span class="c1"># plt.xlabel(&#39;star_truth_mags[zpt_mask] - star_fit_mags[zpt_mask]&#39;)</span>
            <span class="c1"># plt.savefig(savepath, dpi=300, bbox_inches=&#39;tight&#39;)</span>
            <span class="c1"># plt.close()</span>

        <span class="k">return</span> <span class="n">zpt</span><span class="p">,</span> <span class="n">ap_zpt</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">make_phot_info_dict</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">,</span> <span class="n">ap_r</span><span class="o">=</span><span class="mi">4</span> <span class="p">):</span>
        <span class="c1"># Do photometry on stamp because it will read faster</span>
        <span class="n">diff_img_stamp_path</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">diff_stamp_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span>
        <span class="n">diff_img_var_stamp_path</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">diff_var_stamp_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span>

        <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;sci_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;templ_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;mjd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">mjd</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;pointing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">pointing</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;sca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;template_pointing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">pointing</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;template_sca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span>

        <span class="k">if</span> <span class="n">diff_img_stamp_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="c1"># Load in the difference image stamp.</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">diff_img_stamp_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">diff_hdu</span><span class="p">:</span>
                <span class="n">diffimg</span> <span class="o">=</span> <span class="n">diff_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">diff_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">diff_img_var_stamp_path</span> <span class="p">)</span> <span class="k">as</span> <span class="n">var_hdu</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">var_hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="p">)</span>

            <span class="c1"># Load in the decorrelated PSF.</span>
            <span class="n">psfpath</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_psf_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">psfpath</span> <span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
                <span class="n">psf</span> <span class="o">=</span> <span class="n">psfmodel</span><span class="p">(</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="p">)</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
            <span class="n">pxcoords</span> <span class="o">=</span> <span class="n">skycoord_to_pixel</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">wcs</span><span class="p">)</span>
            <span class="n">results_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">phot_at_coords</span><span class="p">(</span><span class="n">diffimg</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">pxcoords</span><span class="o">=</span><span class="n">pxcoords</span><span class="p">,</span> <span class="n">ap_r</span><span class="o">=</span><span class="n">ap_r</span><span class="p">)</span> <span class="p">)</span>

            <span class="c1"># Get the zero point from the decorrelated, convolved science image.</span>
            <span class="c1"># First, get the table of known stars.</span>

            <span class="c1"># TODO -- take this galsim-specific code out, move it to a separate module.  Define a general</span>
            <span class="c1">#  zeropointing interface, of which the galsim-speicifc one will be one instance</span>
            <span class="n">truthpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">tds_base_dir</span> <span class="o">/</span>
                             <span class="sa">f</span><span class="s1">&#39;truth/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s1">/&#39;</span>
                             <span class="sa">f</span><span class="s1">&#39;Roman_TDS_index_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="si">}</span><span class="s1">.txt&#39;</span> <span class="p">)</span>
            <span class="n">stars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stars</span><span class="p">(</span><span class="n">truthpath</span><span class="p">)</span>
            <span class="c1"># Now, calculate the zero point based on those stars.</span>
            <span class="n">zptimg_path</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_zptimg_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">zptimg_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdu</span><span class="p">:</span>
                <span class="n">zptimg</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

            <span class="n">zpt</span><span class="p">,</span> <span class="n">ap_zpt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zpt</span><span class="p">(</span><span class="n">zptimg</span><span class="p">,</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">noise</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">oid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span>
                               <span class="n">sci_pointing</span><span class="o">=</span><span class="n">sci_image</span><span class="o">.</span><span class="n">pointing</span><span class="p">,</span> <span class="n">sci_sca</span><span class="o">=</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="p">)</span>

            <span class="c1"># Add additional info to the results dictionary so it can be merged into a nice file later.</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;zpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zpt</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;ap_zpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ap_zpt</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Post-processed image files for &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="si">}</span><span class="s2">-&quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="si">}</span><span class="s2"> &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;do not exist.  Skipping.&quot;</span> <span class="p">)</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;zpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;ap_zpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;aperture_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;flux_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;flux_fit_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;mag_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s1">&#39;mag_fit_err&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">return</span> <span class="n">results_dict</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_to_results_dict</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">one_pair</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">one_pair</span><span class="p">[</span> <span class="n">key</span> <span class="p">]</span> <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_stamp_paths</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">,</span> <span class="n">paths</span> <span class="p">):</span>
        <span class="n">sci_image</span><span class="o">.</span><span class="n">zpt_stamp_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sci_image</span><span class="o">.</span><span class="n">diff_stamp_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sci_image</span><span class="o">.</span><span class="n">diff_var_stamp_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">paths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">do_stamps</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span> <span class="p">):</span>

        <span class="n">zptname</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_zptimg_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span>
        <span class="n">zpt_stampname</span> <span class="o">=</span> <span class="n">stampmaker</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]),</span>
                                    <span class="n">zptname</span><span class="p">,</span>
                                    <span class="n">savedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span><span class="p">,</span>
                                    <span class="n">savename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;stamp_</span><span class="si">{</span><span class="n">zptname</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

        <span class="n">diffname</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_diff_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span>
        <span class="n">diff_stampname</span> <span class="o">=</span> <span class="n">stampmaker</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]),</span>
                                     <span class="n">diffname</span><span class="p">,</span>
                                     <span class="n">savedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span><span class="p">,</span>
                                     <span class="n">savename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;stamp_</span><span class="si">{</span><span class="n">diffname</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

        <span class="n">diffvarname</span> <span class="o">=</span> <span class="n">sci_image</span><span class="o">.</span><span class="n">diff_var_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span>
        <span class="n">diffvar_stampname</span> <span class="o">=</span> <span class="n">stampmaker</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]),</span>
                                        <span class="n">diffvarname</span><span class="p">,</span>
                                        <span class="n">savedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span><span class="p">,</span>
                                        <span class="n">savename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;stamp_</span><span class="si">{</span><span class="n">diffvarname</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>

        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decorrelated diff stamp path: </span><span class="si">{</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="w"> </span><span class="n">diff_stampname</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Zpt image stamp path: </span><span class="si">{</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="w"> </span><span class="n">zpt_stampname</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decorrelated diff variance stamp path: </span><span class="si">{</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="w"> </span><span class="n">diffvar_stampname</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">zpt_stampname</span> <span class="p">),</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">diff_stampname</span> <span class="p">),</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span> <span class="n">diffvar_stampname</span> <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_lightcurve</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Making lightcurve.&quot;</span> <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;ra&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;dec&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;mjd&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;filter&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;pointing&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;sca&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;template_pointing&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;template_sca&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;zpt&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;ap_zpt&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;aperture_sum&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;flux_fit&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;flux_fit_err&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;mag_fit&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;mag_fit_err&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocs</span> <span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sci_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">templ_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span><span class="p">:</span>
                        <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_phot_info_dict</span><span class="p">,</span> <span class="p">(</span><span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">),</span> <span class="p">{},</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">add_to_results_dict</span><span class="p">,</span>
                                          <span class="n">error_callback</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">SNLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;make_phot_info_dict &quot;</span>
                                                                                   <span class="sa">f</span><span class="s2">&quot;subprocess failure: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                                         <span class="p">)</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sci_image</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span> <span class="p">):</span>
                <span class="n">SNLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Doing science image </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                <span class="k">for</span> <span class="n">templ_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_results_dict</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_phot_info_dict</span><span class="p">(</span> <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span> <span class="p">)</span> <span class="p">)</span>

        <span class="n">results_tab</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_dict</span><span class="p">)</span>
        <span class="n">results_tab</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;mjd&#39;</span><span class="p">)</span>
        <span class="n">results_savedir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ltcv_dir</span> <span class="o">/</span> <span class="s1">&#39;data&#39;</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object_id</span><span class="p">)</span>
        <span class="n">results_savedir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="n">results_savepath</span> <span class="o">=</span> <span class="n">results_savedir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">object_id</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s1">_all.csv&#39;</span>
        <span class="n">results_tab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">results_savepath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Results saved to </span><span class="si">{</span><span class="n">results_savepath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write_fits_file</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">savepath</span> <span class="p">):</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear_contents</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">directory</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">directory</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span> <span class="n">f</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="sa">f</span><span class="s1">&#39;Oops! Deleting </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s1"> from </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s1"> did not work.</span><span class="se">\n</span><span class="s1">Reason: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">through_step</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span><span class="p">:</span>
            <span class="n">tracemalloc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">tracemalloc</span><span class="o">.</span><span class="n">reset_peak</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">through_step</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">through_step</span> <span class="o">=</span> <span class="s1">&#39;make_lightcurve&#39;</span>

        <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;sky_subtract&#39;</span><span class="p">,</span> <span class="s1">&#39;get_psfs&#39;</span><span class="p">,</span> <span class="s1">&#39;align_and_preconvolve&#39;</span><span class="p">,</span> <span class="s1">&#39;subtract&#39;</span><span class="p">,</span> <span class="s1">&#39;find_decorrelation&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;apply_decorrelation&#39;</span><span class="p">,</span> <span class="s1">&#39;make_stamps&#39;</span><span class="p">,</span> <span class="s1">&#39;make_lightcurve&#39;</span> <span class="p">]</span>
        <span class="n">stepdex</span> <span class="o">=</span> <span class="n">steps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">through_step</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">stepdex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Unknown step </span><span class="si">{</span><span class="n">through_step</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[:</span><span class="n">stepdex</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;sky_subtract&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Running sky subtraction&quot;</span> <span class="p">)</span>
            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;skysub&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff8888</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sky_sub_all_images</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;After sky_subtract, memory usage = </span><span class="si">{</span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;get_psfs&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Getting PSFs&quot;</span> <span class="p">)</span>
            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;getpsfs&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff8888</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_psfs</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;After get_psfs, memory usage = </span><span class="si">{</span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span> <span class="p">)</span>

        <span class="c1"># Create a process pool to write fits files</span>
        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwrite</span> <span class="p">)</span> <span class="k">as</span> <span class="n">fits_writer_pool</span><span class="p">:</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">log_fits_write_error</span><span class="p">(</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">x</span> <span class="p">):</span>
                <span class="n">SNLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Exception writing FITS file </span><span class="si">{</span><span class="n">savepath</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                <span class="c1"># raise?</span>

            <span class="c1"># Do the hardcore processing</span>

            <span class="k">for</span> <span class="n">templ_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sci_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="p">:</span>
                    <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> minus </span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                    <span class="n">sfftifier</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="s1">&#39;align_and_preconvolve&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;...align_and_preconvolve&quot;</span> <span class="p">)</span>
                        <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;align_and_pre_convolve&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0x8888ff</span> <span class="p">):</span>
                            <span class="n">sfftifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_and_pre_convolve</span><span class="p">(</span> <span class="n">templ_image</span><span class="p">,</span> <span class="n">sci_image</span> <span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;subtract&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;...subtract&quot;</span> <span class="p">)</span>
                        <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;subtraction&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0x44ccff</span> <span class="p">):</span>
                            <span class="n">sfftifier</span><span class="o">.</span><span class="n">sfft_subtraction</span><span class="p">()</span>

                    <span class="k">if</span> <span class="s1">&#39;find_decorrelation&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;...find_decorrelation&quot;</span> <span class="p">)</span>
                        <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;find_decor&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xcc44ff</span> <span class="p">):</span>
                            <span class="n">sfftifier</span><span class="o">.</span><span class="n">find_decorrelation</span><span class="p">()</span>

                        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;...generate variance image&quot;</span> <span class="p">)</span>
                        <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;variance&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0x44ccff</span> <span class="p">):</span>
                            <span class="n">diff_var</span> <span class="o">=</span> <span class="n">sfftifier</span><span class="o">.</span><span class="n">create_variance_image</span><span class="p">()</span>
                            <span class="n">mess</span> <span class="o">=</span> <span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="si">}</span><span class="s2">_-&quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="si">}</span><span class="s2">.fits&quot;</span> <span class="p">)</span>
                            <span class="n">diff_var_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;diff_var_</span><span class="si">{</span><span class="n">mess</span><span class="si">}</span><span class="s2">&quot;</span>

                    <span class="k">if</span> <span class="s1">&#39;apply_decorrelation&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                        <span class="n">mess</span> <span class="o">=</span> <span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="si">}</span><span class="s2">_-&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="si">}</span><span class="s2">.fits&quot;</span> <span class="p">)</span>
                        <span class="n">decorr_psf_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;decorr_psf_</span><span class="si">{</span><span class="n">mess</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">decorr_zptimg_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;decorr_zptimg_</span><span class="si">{</span><span class="n">mess</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">decorr_diff_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;decorr_diff_</span><span class="si">{</span><span class="n">mess</span><span class="si">}</span><span class="s2">&quot;</span>

                        <span class="n">images</span> <span class="o">=</span>    <span class="p">[</span> <span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_DIFF_GPU</span><span class="p">,</span>    <span class="n">diff_var</span><span class="p">,</span>
                                      <span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_Ctarget_GPU</span><span class="p">,</span> <span class="n">sfftifier</span><span class="o">.</span><span class="n">PSF_target_GPU</span> <span class="p">]</span>
                        <span class="n">savepaths</span> <span class="o">=</span> <span class="p">[</span> <span class="n">decorr_diff_path</span><span class="p">,</span>           <span class="n">diff_var_path</span><span class="p">,</span>
                                      <span class="n">decorr_zptimg_path</span><span class="p">,</span>         <span class="n">decorr_psf_path</span> <span class="p">]</span>
                        <span class="n">headers</span> <span class="o">=</span>   <span class="p">[</span> <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">,</span>       <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">,</span>
                                      <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">,</span>       <span class="kc">None</span> <span class="p">]</span>

                        <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">savepath</span><span class="p">,</span> <span class="n">hdr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span> <span class="n">images</span><span class="p">,</span> <span class="n">savepaths</span><span class="p">,</span> <span class="n">headers</span> <span class="p">):</span>
                            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;apply_decor&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xccccff</span> <span class="p">):</span>
                                <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;...apply_decor to </span><span class="si">{</span><span class="n">savepath</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                                <span class="n">decorimg</span> <span class="o">=</span> <span class="n">sfftifier</span><span class="o">.</span><span class="n">apply_decorrelation</span><span class="p">(</span> <span class="n">img</span> <span class="p">)</span>
                            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;submit writefits&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff8888</span> <span class="p">):</span>
                                <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;...writefits </span><span class="si">{</span><span class="n">savepath</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                                <span class="n">fits_writer_pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_fits_file</span><span class="p">,</span>
                                                              <span class="p">(</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span> <span class="n">decorimg</span> <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">savepath</span> <span class="p">),</span> <span class="p">{},</span>
                                                              <span class="n">error_callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">log_fits_write_error</span><span class="p">,</span> <span class="n">savepath</span><span class="p">)</span> <span class="p">)</span>
                        <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_psf_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">decorr_psf_path</span>
                        <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_zptimg_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">decorr_zptimg_path</span>
                        <span class="n">sci_image</span><span class="o">.</span><span class="n">decorr_diff_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">decorr_diff_path</span>
                        <span class="n">sci_image</span><span class="o">.</span><span class="n">diff_var_path</span><span class="p">[</span> <span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">diff_var_path</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_intermediate</span><span class="p">:</span>
                        <span class="c1"># Each key is the file prefix addition.</span>
                        <span class="c1"># Each list has [descriptive filetype, image file name, data, header].</span>

                        <span class="c1"># TODO: Include multiprocessing.</span>
                        <span class="c1"># In the future, we may want to write these things right after they happen</span>
                        <span class="c1"># instead of saving it all for the end of the SFFT stuff.</span>

                        <span class="n">sci_filepathpart</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="n">templ_filepathpart</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">band</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">pointing</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">sca</span><span class="si">}</span><span class="s1">&#39;</span>

                        <span class="n">write_filepaths</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;aligned&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span>
                                                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">templ_filepathpart</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">sci_filepathpart</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                        <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_resamp_object_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                        <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">],</span>
                                                        <span class="p">[</span><span class="s1">&#39;var&#39;</span><span class="p">,</span>
                                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">templ_filepathpart</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">sci_filepathpart</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                         <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_resamp_objectVar_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                         <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">],</span>
                                                       <span class="p">[</span><span class="s1">&#39;psf&#39;</span><span class="p">,</span>
                                                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">templ_filepathpart</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">sci_filepathpart</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                        <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PSF_resamp_object_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                        <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">],</span>
                                                       <span class="p">[</span><span class="s1">&#39;detmask&#39;</span><span class="p">,</span>
                                                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sci_filepathpart</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">templ_filepathpart</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                        <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_resamp_object_DMASK_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                        <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">]</span>
                                                       <span class="p">],</span>
                                           <span class="s1">&#39;convolved&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span>
                                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sci_filepathpart</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">templ_filepathpart</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                         <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_Ctarget_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                         <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">],</span>
                                                         <span class="p">[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span>
                                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">templ_filepathpart</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">sci_filepathpart</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                         <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_Cresamp_object_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                         <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">]</span>
                                                        <span class="p">],</span>
                                           <span class="s1">&#39;diff&#39;</span><span class="p">:</span>     <span class="p">[[</span><span class="s1">&#39;img&#39;</span><span class="p">,</span>
                                                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sci_filepathpart</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">templ_filepathpart</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                        <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">PixA_DIFF_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                        <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">]</span>
                                                       <span class="p">],</span>
                                           <span class="s1">&#39;decorr&#39;</span><span class="p">:</span>   <span class="p">[[</span><span class="s1">&#39;kernel&#39;</span><span class="p">,</span>
                                                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sci_filepathpart</span><span class="si">}</span><span class="s1">_-_</span><span class="si">{</span><span class="n">templ_filepathpart</span><span class="si">}</span><span class="s1">.fits&#39;</span><span class="p">,</span>
                                                        <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">sfftifier</span><span class="o">.</span><span class="n">FKDECO_GPU</span><span class="o">.</span><span class="n">T</span><span class="p">),</span>
                                                        <span class="n">sfftifier</span><span class="o">.</span><span class="n">hdr_target</span><span class="p">]</span>
                                                       <span class="p">]</span>
                                          <span class="p">}</span>
                        <span class="c1"># Write the aligned images</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">write_filepaths</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">for</span> <span class="p">(</span><span class="n">imgtype</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span> <span class="ow">in</span> <span class="n">write_filepaths</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                                <span class="n">savepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scratch_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">imgtype</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">write_fits_file</span><span class="p">(</span> <span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">savepath</span> <span class="p">)</span>

                    <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;DONE processing </span><span class="si">{</span><span class="n">sci_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> minus </span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span><span class="p">:</span>
                        <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;After preprocessing, subtracting, and postprocessing </span><span class="se">\</span>
<span class="s2">                                        a science image, memory usage = </span><span class="se">\</span>
<span class="s2">                                         </span><span class="si">{</span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span> <span class="p">)</span>

                    <span class="n">sci_image</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>

                <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;DONE with all science images for template </span><span class="si">{</span><span class="n">templ_image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">)</span>
                <span class="n">templ_image</span><span class="o">.</span><span class="n">free</span><span class="p">()</span>

            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Waiting for FITS writer processes to finish&quot;</span> <span class="p">)</span>
            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;fits_write_wait&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff8888</span> <span class="p">):</span>
                <span class="n">fits_writer_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">fits_writer_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;...FITS writer processes done.&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;make_stamps&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Starting to make stamps...&quot;</span> <span class="p">)</span>
            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;make stamps&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff8888</span> <span class="p">):</span>
                <span class="n">partialstamp</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">stampmaker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]))</span>
                <span class="c1"># template path, savedir, savename</span>
                <span class="n">templstamp_args</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dia_out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;stamp_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ti</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span> <span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwrite</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwrite</span> <span class="p">)</span> <span class="k">as</span> <span class="n">templ_stamp_pool</span><span class="p">:</span>
                        <span class="n">templ_stamp_pool</span><span class="o">.</span><span class="n">starmap_async</span><span class="p">(</span> <span class="n">partialstamp</span><span class="p">,</span> <span class="n">templstamp_args</span> <span class="p">)</span>
                        <span class="n">templ_stamp_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">templ_stamp_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

                    <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwrite</span> <span class="p">)</span> <span class="k">as</span> <span class="n">sci_stamp_pool</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">sci_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">templ_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span><span class="p">:</span>
                                <span class="n">pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">)</span>
                                <span class="n">sci_stamp_pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_stamps</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="p">{},</span>
                                                            <span class="n">callback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_stamp_paths</span><span class="p">,</span>
                                                                               <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">),</span>
                                                            <span class="n">error_callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">SNLogger</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                                                                                   <span class="s2">&quot;do_stamps subprocess failure: </span><span class="si">{x}</span><span class="s2">&quot;</span><span class="p">)</span>
                                                           <span class="p">)</span>

                        <span class="n">sci_stamp_pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">sci_stamp_pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tsargs</span> <span class="ow">in</span> <span class="n">templstamp_args</span><span class="p">:</span>
                        <span class="n">partialstamp</span><span class="p">(</span><span class="o">*</span><span class="n">tsargs</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">sci_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">science_images</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">templ_image</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_images</span><span class="p">:</span>
                            <span class="n">stamp_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_stamps</span><span class="p">(</span> <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">save_stamp_paths</span><span class="p">(</span> <span class="n">sci_image</span><span class="p">,</span> <span class="n">templ_image</span><span class="p">,</span> <span class="n">stamp_paths</span> <span class="p">)</span>

            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;...finished making stamps.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;After make_stamps, memory usage = </span><span class="si">{</span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;make_lightcurve&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;Making lightcurve&quot;</span> <span class="p">)</span>
            <span class="k">with</span> <span class="n">nvtx</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span> <span class="s2">&quot;make_lightcurve&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="mh">0xff8888</span> <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">make_lightcurve</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_trace</span><span class="p">:</span>
            <span class="n">SNLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;After make_lightcurve, memory usage = </span><span class="se">\</span>
<span class="s2">                            </span><span class="si">{</span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">get_traced_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_temp_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_contents</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="p">)</span></div>


                <span class="c1"># ======================================================================</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Run one arg pass just to get the config file, so we can augment</span>
    <span class="c1">#   the full arg parser later with config options</span>
    <span class="n">configparser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span> <span class="n">add_help</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>
    <span class="n">configparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--config-file&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">help</span><span class="o">=</span><span class="p">(</span> <span class="s2">&quot;Location of the .yaml config file; defaults to the value of the &quot;</span>
                                      <span class="s2">&quot;SNPIT_CONFIG environment varaible.&quot;</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">args</span><span class="p">,</span> <span class="n">leftovers</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">Config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">config_file</span><span class="p">,</span> <span class="n">setdefault</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;No default config defined yet; run Config.init(configfile)&#39;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s2">&quot;Error, no configuration file defined.</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot;Either run phrosty with -c &lt;configfile&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="s2">&quot;or set the SNPIT_CONFIG environment varaible.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="c1"># Put in the config_file argument, even though it will never be found, so it shows up in help</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--config-file&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Location of the .yaml config file&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;--oid&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Object ID&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--ra&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Object RA&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--dec&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Object Dec&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--band&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Band: R062, Z087, Y106, J129, H158, F184, or K213&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--template-images&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to file with, per line, ( path_to_image, pointing, sca )&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--science-images&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to file with, per line, ( path_to_image, pointing, sca )&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--nprocs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of process for multiprocessing steps (e.g. skysub)&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="s1">&#39;--nwrite&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of parallel FITS writing processes&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show debug log info&quot;</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span> <span class="s1">&#39;--through-step&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;make_lightcurve&#39;</span><span class="p">,</span>
                         <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stop after this step; one of (see above)&quot;</span> <span class="p">)</span>

    <span class="n">cfg</span><span class="o">.</span><span class="n">augment_argparse</span><span class="p">(</span> <span class="n">parser</span> <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span> <span class="n">leftovers</span> <span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span> <span class="n">args</span> <span class="p">)</span>

    <span class="n">science_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">template_images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">infile</span><span class="p">,</span> <span class="n">imlist</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span> <span class="p">[</span> <span class="n">args</span><span class="o">.</span><span class="n">science_images</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">template_images</span> <span class="p">],</span>
                               <span class="p">[</span> <span class="n">science_images</span><span class="p">,</span> <span class="n">template_images</span> <span class="p">]</span> <span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">infile</span> <span class="p">)</span> <span class="k">as</span> <span class="n">ifp</span><span class="p">:</span>
            <span class="n">hdrline</span> <span class="o">=</span> <span class="n">ifp</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span> <span class="sa">r</span><span class="s2">&quot;^\s*path\s+pointing\s+sca\s+mjd\s+band\s*$&quot;</span><span class="p">,</span> <span class="n">hdrline</span> <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;First line of list file </span><span class="si">{</span><span class="n">infile</span><span class="si">}</span><span class="s2"> didn&#39;t match what was expected.&quot;</span> <span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ifp</span><span class="p">:</span>
                <span class="n">img</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">sca</span><span class="p">,</span> <span class="n">mjd</span><span class="p">,</span> <span class="n">band</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">imlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">point</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">sca</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">mjd</span><span class="p">),</span> <span class="n">band</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">oid</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">band</span><span class="p">,</span> <span class="n">science_images</span><span class="p">,</span> <span class="n">template_images</span><span class="p">,</span>
                         <span class="n">nprocs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">nwrite</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">nwrite</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span> <span class="p">)</span>
    <span class="n">pipeline</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">through_step</span> <span class="p">)</span>


<span class="c1"># ======================================================================</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2025, Roman Supernova PIT.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>